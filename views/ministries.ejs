<%- include('partials/header', { title: 'Nos Ministères' }) %>

    <!-- HEADER PAGE -->
    <header class="bg-primary pt-32 pb-20 text-center text-white relative">
         <div class="absolute inset-0 z-0 bg-[url('https://images.unsplash.com/photo-1544427920-2102a3d077ce?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center opacity-30"></div>
        <div class="max-w-4xl mx-auto px-4 relative z-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">La Vie de l'Église</h1>
            <p class="text-xl text-slate-300 mb-8">S'investir, Grandir et Servir ensemble.</p>
            
            <% if (typeof user !== 'undefined' && user) { %>
                <a href="/ministries/new" class="inline-flex items-center gap-2 bg-white text-primary px-6 py-3 rounded-full font-bold shadow-lg hover:bg-slate-100 transition transform hover:-translate-y-1">
                    <i class="ph-bold ph-plus-circle text-xl"></i> Ajouter un Ministère
                </a>
            <% } %>
        </div>
    </header>

    <% if (typeof ministries !== 'undefined' && ministries.length > 0) { %>
        <% ministries.forEach(function(ministry, index) { %>
    <section id="ministry-<%= ministry.id %>" class="py-16 <%= index % 2 !== 0 ? 'bg-slate-100' : 'bg-white overflow-hidden' %>">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col <%= index % 2 !== 0 ? 'md:flex-row-reverse' : 'md:flex-row' %> items-center gap-12">
                <div class="md:w-1/2 relative group">
                    <img src="<%= ministry.image_url %>" alt="<%= ministry.name %>" class="rounded-2xl shadow-xl w-full object-cover h-64 md:h-96 transition duration-500 transform group-hover:scale-[1.01]">
                    
                    <% if (typeof user !== 'undefined' && user) { %>
                        <div class="absolute top-4 right-4 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <a href="/ministries/edit/<%= ministry.id %>" class="bg-white/90 backdrop-blur-md hover:bg-blue-50 text-blue-600 p-3 rounded-full shadow-lg transition-transform hover:scale-110" title="Modifier">
                                <i class="ph-bold ph-pencil-simple text-xl"></i>
                            </a>
                            <button type="button" onclick="openDeleteModal('<%= ministry.id %>')" class="bg-white/90 backdrop-blur-md hover:bg-red-50 text-red-600 p-3 rounded-full shadow-lg transition-transform hover:scale-110" title="Supprimer">
                                <i class="ph-bold ph-trash text-xl"></i>
                            </button>
                            <form id="delete-form-<%= ministry.id %>" action="/ministries/delete/<%= ministry.id %>" method="POST" class="hidden"></form>
                        </div>
                    <% } %>
                </div>
                <div class="md:w-1/2">
                    <span class="text-accent font-bold uppercase tracking-wider text-sm mb-2 block"><%= ministry.short_description %></span>
                    <h2 class="text-3xl font-bold text-primary mb-6"><%= ministry.name %></h2>
                    <p class="text-lg text-slate-600 mb-6 leading-relaxed">
                        <%= ministry.description %>
                    </p>
                    <div class="bg-white p-6 rounded-xl border-l-4 border-accent shadow-sm">
                        <p class="font-bold text-primary">Rencontres</p>
                        <p class="text-slate-600"><%= ministry.schedule %></p>
                    </div>
                </div>
            </div>
        </div>
    </section>
        <% }); %>
    <% } else { %>
        <section class="py-16 bg-white">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p>Aucun ministère à afficher pour le moment.</p>
            </div>
        </section>
    <% } %>

    <!-- GROUPES MAISON -->
    <section class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-3xl font-bold text-primary mb-6">Les Groupes Maison</h2>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto mb-12">
                Parce qu'on ne peut pas connaître tout le monde le dimanche matin, les groupes maison sont l'endroit idéal pour créer des liens profonds.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-left">
                <% if (typeof houseGroups !== 'undefined' && houseGroups.length > 0) { %>
                    <% houseGroups.forEach(function(group) { %>
                <div class="p-6 border rounded-xl hover:shadow-md transition bg-slate-50">
                    <h3 class="font-bold text-lg mb-1"><%= group.name %></h3>
                    <p class="text-sm text-slate-500 mb-3"><%= group.day_time %></p>
                    <p class="text-slate-700 text-sm"><%= group.description %></p>
                </div>
                    <% }); %>
                <% } else { %>
                    <p class="col-span-full text-center text-slate-400">Aucun groupe maison pour le moment.</p>
                <% } %>
            </div>
            
            <button onclick="openJoinModal()" class="mt-10 bg-primary text-white px-8 py-3 rounded-full font-semibold hover:bg-slate-800 transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                Rejoindre un groupe
            </button>
        </div>
    </section>

    <!-- Modal Rejoindre un Groupe -->
    <div id="joinModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0 px-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full transform scale-95 transition-transform duration-200 relative" id="joinModalContent">
            <button onclick="closeJoinModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition">
                <i class="ph-bold ph-x text-2xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3 text-primary">
                    <i class="ph-fill ph-users-three text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-900">Rejoindre un groupe</h3>
                <p class="text-slate-500 mt-2">Remplissez ce formulaire et un responsable de groupe vous contactera bientôt.</p>
            </div>

            <form action="/contact/send" method="POST" class="space-y-4">
                <input type="hidden" name="sujet" value="Demande pour rejoindre un Groupe Maison">
                <input type="hidden" name="redirect_to" value="/ministries">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Prénom</label>
                        <input type="text" name="prenom" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nom</label>
                        <input type="text" name="nom" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" name="email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Groupe souhaité (Optionnel)</label>
                    <select name="message_groupe" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition bg-white">
                        <option value="">Je ne sais pas encore / N'importe quel groupe</option>
                        <% if (typeof houseGroups !== 'undefined' && houseGroups.length > 0) { %>
                            <% houseGroups.forEach(function(group) { %>
                                <option value="<%= group.name %>"><%= group.name %> (<%= group.day_time %>)</option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                
                <!-- Hidden inputs to construct the final message in backend if needed, 
                     or we use a script to concatenate before submit. 
                     For simplicity, let's just put the preference in 'message' via JS or change backend.
                     Client-side JS is easiest here to avoid backend changes. -->
                <input type="hidden" name="message" id="finalMessage">

                <button type="submit" onclick="prepareMessage()" class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 mt-2">
                    Envoyer ma demande
                </button>
            </form>
        </div>
    </div>

    <!-- Script pour le Modal -->
    <script>
        const joinModal = document.getElementById('joinModal');
        const joinModalContent = document.getElementById('joinModalContent');

        function openJoinModal() {
            joinModal.classList.remove('hidden');
            joinModal.classList.add('flex');
            setTimeout(() => {
                joinModal.classList.remove('opacity-0');
                joinModalContent.classList.remove('scale-95');
                joinModalContent.classList.add('scale-100');
            }, 10);
        }

        function closeJoinModal() {
            joinModal.classList.add('opacity-0');
            joinModalContent.classList.add('scale-95');
            joinModalContent.classList.remove('scale-100');
            setTimeout(() => {
                joinModal.classList.add('hidden');
                joinModal.classList.remove('flex');
            }, 300);
        }

        // Close on click outside
        joinModal.addEventListener('click', (e) => {
            if (e.target === joinModal) closeJoinModal();
        });

        function prepareMessage() {
            const select = document.querySelector('select[name="message_groupe"]');
            const groupe = select.value || "Non spécifié";
            const finalMsgInput = document.getElementById('finalMessage');
            finalMsgInput.value = `Bonjour, je souhaiterais rejoindre un groupe maison.\nPréférence : ${groupe}`;
        }
    </script>

    <div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200" id="deleteModalContent">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
                    <i class="ph-bold ph-trash text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Confirmer la suppression</h3>
                <p class="text-slate-500 mb-6">Êtes-vous sûr de vouloir supprimer ce ministère ? Cette action est irréversible.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeDeleteModal()" class="px-5 py-2.5 rounded-xl border border-slate-200 text-slate-700 font-semibold hover:bg-slate-50 transition">Annuler</button>
                    <button onclick="confirmDelete()" class="px-5 py-2.5 rounded-xl bg-red-600 text-white font-semibold hover:bg-red-700 shadow-lg shadow-red-200 transition">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let deleteId = null;
        const modal = document.getElementById('deleteModal');
        const modalContent = document.getElementById('deleteModalContent');

        function openDeleteModal(id) {
            deleteId = id;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Petit délai pour l'animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeDeleteModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                deleteId = null;
            }, 300);
        }

        function confirmDelete() {
            if (deleteId) {
                document.getElementById('delete-form-' + deleteId).submit();
            }
        }

        // Fermer si on clique en dehors
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeDeleteModal();
            }
        });
    </script>
    
  <%- include('partials/footer') %>
